from tarvis.inference.dataset_parser.dataset_parser_base import DatasetParserBase

import json
import os.path as osp


class VIPSegDatasetParser(DatasetParserBase):
    def __init__(self, images_base_dir: str, panoptic_gt_json_file: str):
        super().__init__("panoptic_seg", "VIPSEG")

        self.images_base_dir = images_base_dir
        with open(panoptic_gt_json_file, 'r') as fh:
            videos = json.load(fh)["videos"]

        self.sequence_dirnames = []
        self.sequence_image_filenames = dict()
        self.dirname_to_image_dims = dict()

        for vid in videos:
            video_id = vid['video_id']
            self.sequence_dirnames.append(video_id)
            self.sequence_image_filenames[video_id] = [x['file_name'].replace(".png", ".jpg") for x in vid['images']]
            self.dirname_to_image_dims[video_id] = [vid['images'][0]['height'], vid['images'][0]['width']]

    @property
    def category_labels(self):
        return self._category_labels

    def __getitem__(self, index):
        dirname = self.sequence_dirnames[index]

        seq_info = self.get_base_seq_info()
        seq_info.update({
            "dirname": dirname,
            "image_paths": [osp.join(self.images_base_dir, dirname, f) for f in self.sequence_image_filenames[dirname]],
            "video_id": dirname,
            "image_dims": self.dirname_to_image_dims[dirname],
            "thing_class_ids": self._thing_classes
        })

        return seq_info

    _category_labels = {
        0: 'wall',
        1: 'ceiling',
        2: 'door',
        3: 'stair',
        4: 'ladder',
        5: 'escalator',
        6: 'Playground_slide',
        7: 'handrail_or_fence',
        8: 'window',
        9: 'rail',
        10: 'goal',
        11: 'pillar',
        12: 'pole',
        13: 'floor',
        14: 'ground',
        15: 'grass',
        16: 'sand',
        17: 'athletic_field',
        18: 'road',
        19: 'path',
        20: 'crosswalk',
        21: 'building',
        22: 'house',
        23: 'bridge',
        24: 'tower',
        25: 'windmill',
        26: 'well_or_well_lid',
        27: 'other_construction',
        28: 'sky',
        29: 'mountain',
        30: 'stone',
        31: 'wood',
        32: 'ice',
        33: 'snowfield',
        34: 'grandstand',
        35: 'sea',
        36: 'river',
        37: 'lake',
        38: 'waterfall',
        39: 'water',
        40: 'billboard_or_Bulletin_Board',
        41: 'sculpture',
        42: 'pipeline',
        43: 'flag',
        44: 'parasol_or_umbrella',
        45: 'cushion_or_carpet',
        46: 'tent',
        47: 'roadblock',
        48: 'car',
        49: 'bus',
        50: 'truck',
        51: 'bicycle',
        52: 'motorcycle',
        53: 'wheeled_machine',
        54: 'ship_or_boat',
        55: 'raft',
        56: 'airplane',
        57: 'tyre',
        58: 'traffic_light',
        59: 'lamp',
        60: 'person',
        61: 'cat',
        62: 'dog',
        63: 'horse',
        64: 'cattle',
        65: 'other_animal',
        66: 'tree',
        67: 'flower',
        68: 'other_plant',
        69: 'toy',
        70: 'ball_net',
        71: 'backboard',
        72: 'skateboard',
        73: 'bat',
        74: 'ball',
        75: 'cupboard_or_showcase_or_storage_rack',
        76: 'box',
        77: 'traveling_case_or_trolley_case',
        78: 'basket',
        79: 'bag_or_package',
        80: 'trash_can',
        81: 'cage',
        82: 'plate',
        83: 'tub_or_bowl_or_pot',
        84: 'bottle_or_cup',
        85: 'barrel',
        86: 'fishbowl',
        87: 'bed',
        88: 'pillow',
        89: 'table_or_desk',
        90: 'chair_or_seat',
        91: 'bench',
        92: 'sofa',
        93: 'shelf',
        94: 'bathtub',
        95: 'gun',
        96: 'commode',
        97: 'roaster',
        98: 'other_machine',
        99: 'refrigerator',
        100: 'washing_machine',
        101: 'Microwave_oven',
        102: 'fan',
        103: 'curtain',
        104: 'textiles',
        105: 'clothes',
        106: 'painting_or_poster',
        107: 'mirror',
        108: 'flower_pot_or_vase',
        109: 'clock',
        110: 'book',
        111: 'tool',
        112: 'blackboard',
        113: 'tissue',
        114: 'screen_or_television',
        115: 'computer',
        116: 'printer',
        117: 'Mobile_phone',
        118: 'keyboard',
        119: 'other_electronic_product',
        120: 'fruit',
        121: 'food',
        122: 'instrument',
        123: 'train'
    }

    _thing_classes = [
        2,
        4,
        8,
        10,
        41,
        43,
        44,
        46,
        47,
        48,
        49,
        50,
        51,
        52,
        54,
        55,
        56,
        60,
        61,
        62,
        63,
        64,
        65,
        72,
        74,
        76,
        77,
        78,
        79,
        82,
        83,
        84,
        85,
        86,
        87,
        88,
        89,
        90,
        91,
        92,
        95,
        96,
        97,
        99,
        100,
        101,
        102,
        106,
        107,
        108,
        109,
        114,
        115,
        116,
        117,
        118,
        122,
        123,
    ]
